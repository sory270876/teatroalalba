<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Panel de Administraci√≥n - Teatro Al Alba</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    .tab-active { background-color: #7f1d1d; color: white; }
    .image-preview { max-width: 150px; max-height: 150px; object-fit: cover; border-radius: 8px; }
    .gallery-preview { display: flex; flex-wrap: wrap; gap: 8px; margin-top: 8px; }
    .gallery-item { position: relative; }
    .gallery-item .remove-btn { position: absolute; top: -8px; right: -8px; background: #dc2626; color: white; border-radius: 50%; width: 24px; height: 24px; font-size: 14px; cursor: pointer; }
  </style>
</head>
<body class="bg-gray-100 min-h-screen">
  <!-- Login Section -->
  <div id="login-section" class="min-h-screen flex items-center justify-center">
    <div class="bg-white p-8 rounded-lg shadow-lg max-w-md w-full">
      <h1 class="text-2xl font-bold text-gray-800 mb-6 text-center">Panel de Administraci√≥n</h1>
      <p class="text-gray-600 mb-4 text-sm">
        Para usar el panel necesitas un token de GitHub.
        <a href="https://github.com/settings/tokens/new?description=Teatro%20Al%20Alba%20Admin&scopes=repo" target="_blank" class="text-red-700 underline">Crear token aqu√≠</a>
        (marca solo "repo" y genera).
      </p>
      <input type="password" id="token-input" placeholder="Pega tu token aqu√≠"
        class="w-full px-4 py-3 border rounded-lg mb-4 focus:outline-none focus:ring-2 focus:ring-red-600">
      <button onclick="saveToken()"
        class="w-full bg-red-800 text-white py-3 rounded-lg hover:bg-red-900 transition">
        Entrar
      </button>
      <p id="login-error" class="text-red-600 mt-2 text-sm hidden"></p>
    </div>
  </div>

  <!-- Admin Panel -->
  <div id="admin-panel" class="hidden">
    <!-- Header -->
    <header class="bg-red-900 text-white py-4 px-6 shadow-lg">
      <div class="max-w-6xl mx-auto flex justify-between items-center">
        <h1 class="text-xl font-bold">Teatro Al Alba - Admin</h1>
        <div class="flex gap-4 items-center">
          <a href="https://www.teatroalalba.es" target="_blank" class="text-sm hover:underline">Ver web</a>
          <button onclick="logout()" class="text-sm bg-red-800 px-3 py-1 rounded hover:bg-red-700">Salir</button>
        </div>
      </div>
    </header>

    <!-- Tabs -->
    <div class="max-w-6xl mx-auto mt-6 px-4">
      <div class="flex gap-2 mb-6">
        <button onclick="showTab('representaciones')" id="tab-representaciones"
          class="px-6 py-2 rounded-lg font-medium tab-active transition">
          Representaciones
        </button>
        <button onclick="showTab('obras')" id="tab-obras"
          class="px-6 py-2 rounded-lg font-medium bg-gray-200 hover:bg-gray-300 transition">
          Obras
        </button>
      </div>

      <!-- Representaciones Tab -->
      <div id="content-representaciones" class="bg-white rounded-lg shadow-lg p-6">
        <div class="flex justify-between items-center mb-6">
          <h2 class="text-xl font-bold text-gray-800">Representaciones</h2>
          <button onclick="showForm('representacion')"
            class="bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700 transition">
            + Nueva Representaci√≥n
          </button>
        </div>
        <div id="representaciones-list" class="space-y-2">
          <p class="text-gray-500">Cargando...</p>
        </div>
      </div>

      <!-- Obras Tab -->
      <div id="content-obras" class="bg-white rounded-lg shadow-lg p-6 hidden">
        <div class="flex justify-between items-center mb-6">
          <h2 class="text-xl font-bold text-gray-800">Obras</h2>
          <button onclick="showForm('obra')"
            class="bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700 transition">
            + Nueva Obra
          </button>
        </div>
        <div id="obras-list" class="space-y-2">
          <p class="text-gray-500">Cargando...</p>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal Form -->
  <div id="modal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
    <div class="bg-white rounded-lg shadow-xl max-w-2xl w-full mx-4 max-h-[90vh] overflow-y-auto">
      <div class="p-6">
        <div class="flex justify-between items-center mb-6">
          <h3 id="modal-title" class="text-xl font-bold text-gray-800">Nuevo</h3>
          <button onclick="closeModal()" class="text-gray-500 hover:text-gray-700 text-2xl">&times;</button>
        </div>

        <!-- Representacion Form -->
        <form id="form-representacion" class="space-y-4 hidden">
          <div class="grid grid-cols-2 gap-4">
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">Fecha *</label>
              <input type="date" name="date" required class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-red-600">
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">Hora *</label>
              <input type="time" name="time" required class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-red-600">
            </div>
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">Obra *</label>
            <select name="obraSlug" required class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-red-600">
              <option value="">Selecciona una obra...</option>
            </select>
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">Lugar/Teatro *</label>
            <input type="text" name="venue" required placeholder="Ej: Teatro Municipal"
              class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-red-600">
          </div>
          <div class="grid grid-cols-2 gap-4">
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">Ciudad *</label>
              <input type="text" name="city" required placeholder="Ej: Getafe"
                class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-red-600">
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">Provincia *</label>
              <input type="text" name="province" required placeholder="Ej: Madrid"
                class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-red-600">
            </div>
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">Evento/Festival (opcional)</label>
            <input type="text" name="event" placeholder="Ej: Festival de Teatro Amateur"
              class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-red-600">
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">URL de entradas (opcional)</label>
            <input type="url" name="ticketUrl" placeholder="https://..."
              class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-red-600">
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">Precio (opcional)</label>
            <input type="text" name="price" placeholder="Ej: 10‚Ç¨ / Gratuito"
              class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-red-600">
          </div>
          <input type="hidden" name="originalPath">
          <div class="flex gap-3 pt-4">
            <button type="submit" class="flex-1 bg-red-800 text-white py-3 rounded-lg hover:bg-red-900 transition">
              Guardar
            </button>
            <button type="button" onclick="closeModal()" class="flex-1 bg-gray-300 text-gray-700 py-3 rounded-lg hover:bg-gray-400 transition">
              Cancelar
            </button>
          </div>
        </form>

        <!-- Obra Form -->
        <form id="form-obra" class="space-y-4 hidden">
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">T√≠tulo *</label>
            <input type="text" name="title" required placeholder="Ej: 7 Stories"
              class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-red-600">
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">Autor</label>
            <input type="text" name="author" placeholder="Ej: Morris Panych"
              class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-red-600">
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">Descripci√≥n corta *</label>
            <textarea name="description" required rows="3" placeholder="Breve descripci√≥n de la obra..."
              class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-red-600"></textarea>
          </div>
          <div class="grid grid-cols-2 gap-4">
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">A√±o</label>
              <input type="number" name="year" placeholder="2025"
                class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-red-600">
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">Estado *</label>
              <select name="status" required class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-red-600">
                <option value="cartelera">En cartelera</option>
                <option value="anterior">Obra anterior</option>
              </select>
            </div>
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">G√©nero</label>
            <input type="text" name="genre" placeholder="Ej: Comedia, Drama..."
              class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-red-600">
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">ID de YouTube (opcional)</label>
            <input type="text" name="youtubeId" placeholder="Ej: Mco1GdXSzFs"
              class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-red-600">
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">Orden (menor = primero)</label>
            <input type="number" name="order" placeholder="0"
              class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-red-600">
          </div>

          <!-- Imagen de portada -->
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">Imagen de portada *</label>
            <input type="file" id="coverImageFile" accept="image/*"
              class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-red-600">
            <div id="coverImagePreview" class="mt-2"></div>
          </div>

          <!-- Galer√≠a de im√°genes -->
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">Galer√≠a de im√°genes</label>
            <input type="file" id="galleryFiles" accept="image/*" multiple
              class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-red-600">
            <div id="galleryPreview" class="gallery-preview mt-2"></div>
          </div>

          <input type="hidden" name="originalPath">
          <input type="hidden" name="coverImage">
          <input type="hidden" name="gallery">
          <div class="flex gap-3 pt-4">
            <button type="submit" id="btn-submit-obra" class="flex-1 bg-red-800 text-white py-3 rounded-lg hover:bg-red-900 transition">
              Guardar
            </button>
            <button type="button" onclick="closeModal()" class="flex-1 bg-gray-300 text-gray-700 py-3 rounded-lg hover:bg-gray-400 transition">
              Cancelar
            </button>
          </div>
          <p id="upload-status" class="text-sm text-gray-500 text-center hidden">Subiendo im√°genes...</p>
        </form>
      </div>
    </div>
  </div>

  <!-- Toast -->
  <div id="toast" class="fixed bottom-4 right-4 bg-green-600 text-white px-6 py-3 rounded-lg shadow-lg hidden">
    Guardado correctamente
  </div>

  <script>
    const REPO = 'sory270876/teatroalalba';
    const BRANCH = 'main';
    let obras = [];
    let pendingCoverImage = null;
    let pendingGalleryImages = [];
    let existingGalleryImages = [];

    // Token management
    function getToken() {
      return localStorage.getItem('github_token');
    }

    function saveToken() {
      const token = document.getElementById('token-input').value.trim();
      if (!token) {
        showLoginError('Por favor, introduce el token');
        return;
      }
      fetch('https://api.github.com/user', {
        headers: { 'Authorization': `token ${token}` }
      })
      .then(r => {
        if (r.ok) {
          localStorage.setItem('github_token', token);
          init();
        } else {
          showLoginError('Token inv√°lido. Aseg√∫rate de copiar el token completo.');
        }
      })
      .catch(() => showLoginError('Error de conexi√≥n'));
    }

    function showLoginError(msg) {
      const el = document.getElementById('login-error');
      el.textContent = msg;
      el.classList.remove('hidden');
    }

    function logout() {
      localStorage.removeItem('github_token');
      location.reload();
    }

    // API calls
    async function githubAPI(endpoint, options = {}) {
      const token = getToken();
      const response = await fetch(`https://api.github.com/repos/${REPO}${endpoint}`, {
        ...options,
        headers: {
          'Authorization': `token ${token}`,
          'Accept': 'application/vnd.github.v3+json',
          ...options.headers
        }
      });
      return response;
    }

    async function getFiles(path) {
      const response = await githubAPI(`/contents/${path}?ref=${BRANCH}`);
      if (!response.ok) return [];
      return response.json();
    }

    async function getFile(path) {
      const response = await githubAPI(`/contents/${path}?ref=${BRANCH}`);
      if (!response.ok) return null;
      const data = await response.json();
      return {
        content: atob(data.content),
        sha: data.sha
      };
    }

    async function saveFile(path, content, sha = null) {
      const body = {
        message: `Update ${path} via admin panel`,
        content: btoa(unescape(encodeURIComponent(content))),
        branch: BRANCH
      };
      if (sha) body.sha = sha;

      const response = await githubAPI(`/contents/${path}`, {
        method: 'PUT',
        body: JSON.stringify(body)
      });
      return response.ok;
    }

    async function uploadImage(file, folder) {
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = async () => {
          const base64 = reader.result.split(',')[1];
          const filename = `${Date.now()}-${file.name.replace(/[^a-zA-Z0-9.-]/g, '_')}`;
          const path = `public/images/${folder}/${filename}`;

          const response = await githubAPI(`/contents/${path}`, {
            method: 'PUT',
            body: JSON.stringify({
              message: `Upload image ${filename}`,
              content: base64,
              branch: BRANCH
            })
          });

          if (response.ok) {
            resolve(`/images/${folder}/${filename}`);
          } else {
            reject(new Error('Error uploading image'));
          }
        };
        reader.onerror = reject;
        reader.readAsDataURL(file);
      });
    }

    async function deleteFile(path, sha) {
      const response = await githubAPI(`/contents/${path}`, {
        method: 'DELETE',
        body: JSON.stringify({
          message: `Delete ${path} via admin panel`,
          sha: sha,
          branch: BRANCH
        })
      });
      return response.ok;
    }

    // Parse frontmatter
    function parseFrontmatter(content) {
      const match = content.match(/^---\n([\s\S]*?)\n---/);
      if (!match) return {};
      const frontmatter = {};
      const lines = match[1].split('\n');
      let currentKey = null;
      let inArray = false;
      let arrayItems = [];

      for (const line of lines) {
        if (line.match(/^\s*-\s/)) {
          // Array item
          const value = line.replace(/^\s*-\s*"?/, '').replace(/"?\s*$/, '');
          arrayItems.push(value);
        } else if (line.includes(':')) {
          // Save previous array if any
          if (currentKey && inArray) {
            frontmatter[currentKey] = arrayItems;
            arrayItems = [];
            inArray = false;
          }

          const [key, ...rest] = line.split(':');
          const value = rest.join(':').trim();
          currentKey = key.trim();

          if (value === '') {
            inArray = true;
          } else {
            let cleanValue = value;
            if (cleanValue.startsWith('"') && cleanValue.endsWith('"')) {
              cleanValue = cleanValue.slice(1, -1);
            }
            frontmatter[currentKey] = cleanValue;
          }
        }
      }

      // Save last array if any
      if (currentKey && inArray) {
        frontmatter[currentKey] = arrayItems;
      }

      return frontmatter;
    }

    // Load data
    async function loadRepresentaciones() {
      const files = await getFiles('src/content/representaciones');
      const list = document.getElementById('representaciones-list');

      if (!files.length) {
        list.innerHTML = '<p class="text-gray-500">No hay representaciones</p>';
        return;
      }

      const items = [];
      for (const file of files) {
        if (!file.name.endsWith('.md')) continue;
        const data = await getFile(file.path);
        if (data) {
          const fm = parseFrontmatter(data.content);
          items.push({ ...fm, path: file.path, sha: data.sha });
        }
      }

      items.sort((a, b) => new Date(b.date) - new Date(a.date));

      list.innerHTML = items.map(item => `
        <div class="flex justify-between items-center p-4 bg-gray-50 rounded-lg hover:bg-gray-100">
          <div>
            <div class="font-medium text-gray-800">${item.obra || 'Sin obra'}</div>
            <div class="text-sm text-gray-600">${formatDate(item.date)} - ${item.time || ''} | ${item.venue || ''}, ${item.city || ''}</div>
          </div>
          <div class="flex gap-2">
            <button onclick="editRepresentacion('${item.path}')"
              class="text-blue-600 hover:text-blue-800 px-3 py-1 rounded border border-blue-600 hover:bg-blue-50">
              Editar
            </button>
            <button onclick="deleteRepresentacion('${item.path}', '${item.sha}')"
              class="text-red-600 hover:text-red-800 px-3 py-1 rounded border border-red-600 hover:bg-red-50">
              Eliminar
            </button>
          </div>
        </div>
      `).join('');
    }

    async function loadObras() {
      const files = await getFiles('src/content/obras');
      const list = document.getElementById('obras-list');
      obras = [];

      if (!files.length) {
        list.innerHTML = '<p class="text-gray-500">No hay obras</p>';
        return;
      }

      for (const file of files) {
        if (!file.name.endsWith('.md')) continue;
        const data = await getFile(file.path);
        if (data) {
          const fm = parseFrontmatter(data.content);
          const slug = file.name.replace('.md', '');
          obras.push({ ...fm, slug, path: file.path, sha: data.sha, rawContent: data.content });
        }
      }

      const select = document.querySelector('#form-representacion select[name="obraSlug"]');
      select.innerHTML = '<option value="">Selecciona una obra...</option>' +
        obras.map(o => `<option value="${o.slug}" data-title="${o.title}">${o.title}</option>`).join('');

      list.innerHTML = obras.map(item => `
        <div class="flex justify-between items-center p-4 bg-gray-50 rounded-lg hover:bg-gray-100">
          <div class="flex items-center gap-4">
            <img src="${item.coverImage || '/images/placeholder.jpg'}" class="w-16 h-16 object-cover rounded-lg" onerror="this.src='/images/placeholder.jpg'">
            <div>
              <div class="font-medium text-gray-800">${item.title || 'Sin t√≠tulo'}</div>
              <div class="text-sm text-gray-600">${item.status === 'cartelera' ? 'üé≠ En cartelera' : 'üìÅ Anterior'} | ${item.genre || ''}</div>
            </div>
          </div>
          <div class="flex gap-2">
            <button onclick="editObra('${item.path}')"
              class="text-blue-600 hover:text-blue-800 px-3 py-1 rounded border border-blue-600 hover:bg-blue-50">
              Editar
            </button>
          </div>
        </div>
      `).join('');
    }

    // Image handling
    document.getElementById('coverImageFile').addEventListener('change', function(e) {
      const file = e.target.files[0];
      if (file) {
        pendingCoverImage = file;
        const reader = new FileReader();
        reader.onload = function(e) {
          document.getElementById('coverImagePreview').innerHTML =
            `<img src="${e.target.result}" class="image-preview">`;
        };
        reader.readAsDataURL(file);
      }
    });

    document.getElementById('galleryFiles').addEventListener('change', function(e) {
      const files = Array.from(e.target.files);
      files.forEach(file => {
        pendingGalleryImages.push(file);
        const reader = new FileReader();
        reader.onload = function(e) {
          const preview = document.getElementById('galleryPreview');
          const idx = pendingGalleryImages.length - 1 + existingGalleryImages.length;
          preview.innerHTML += `
            <div class="gallery-item" data-idx="${idx}" data-type="new">
              <img src="${e.target.result}" class="image-preview">
              <button type="button" class="remove-btn" onclick="removeGalleryImage(${idx}, 'new')">&times;</button>
            </div>
          `;
        };
        reader.readAsDataURL(file);
      });
    });

    function removeGalleryImage(idx, type) {
      if (type === 'new') {
        const adjustedIdx = idx - existingGalleryImages.length;
        pendingGalleryImages.splice(adjustedIdx, 1);
      } else {
        existingGalleryImages.splice(idx, 1);
      }
      document.querySelector(`.gallery-item[data-idx="${idx}"][data-type="${type}"]`)?.remove();
    }

    // Forms
    function showForm(type) {
      document.getElementById('modal').classList.remove('hidden');
      document.getElementById('modal').classList.add('flex');
      document.getElementById('form-representacion').classList.add('hidden');
      document.getElementById('form-obra').classList.add('hidden');
      document.getElementById(`form-${type}`).classList.remove('hidden');
      document.getElementById(`form-${type}`).reset();
      document.querySelector(`#form-${type} input[name="originalPath"]`).value = '';
      document.getElementById('modal-title').textContent = type === 'representacion' ? 'Nueva Representaci√≥n' : 'Nueva Obra';

      // Reset image state
      if (type === 'obra') {
        pendingCoverImage = null;
        pendingGalleryImages = [];
        existingGalleryImages = [];
        document.getElementById('coverImagePreview').innerHTML = '';
        document.getElementById('galleryPreview').innerHTML = '';
        document.getElementById('coverImageFile').value = '';
        document.getElementById('galleryFiles').value = '';
      }
    }

    function closeModal() {
      document.getElementById('modal').classList.add('hidden');
      document.getElementById('modal').classList.remove('flex');
      pendingCoverImage = null;
      pendingGalleryImages = [];
      existingGalleryImages = [];
    }

    async function editRepresentacion(path) {
      const data = await getFile(path);
      if (!data) return;

      const fm = parseFrontmatter(data.content);
      const form = document.getElementById('form-representacion');

      form.querySelector('[name="date"]').value = fm.date || '';
      form.querySelector('[name="time"]').value = fm.time || '';
      form.querySelector('[name="venue"]').value = fm.venue || '';
      form.querySelector('[name="city"]').value = fm.city || '';
      form.querySelector('[name="province"]').value = fm.province || '';
      form.querySelector('[name="obraSlug"]').value = fm.obraSlug || '';
      form.querySelector('[name="event"]').value = fm.event || '';
      form.querySelector('[name="ticketUrl"]').value = fm.ticketUrl || '';
      form.querySelector('[name="price"]').value = fm.price || '';
      form.querySelector('[name="originalPath"]').value = path;

      document.getElementById('modal').classList.remove('hidden');
      document.getElementById('modal').classList.add('flex');
      document.getElementById('form-representacion').classList.remove('hidden');
      document.getElementById('form-obra').classList.add('hidden');
      document.getElementById('modal-title').textContent = 'Editar Representaci√≥n';
    }

    async function editObra(path) {
      const obra = obras.find(o => o.path === path);
      if (!obra) return;

      const form = document.getElementById('form-obra');

      form.querySelector('[name="title"]').value = obra.title || '';
      form.querySelector('[name="author"]').value = obra.author || '';
      form.querySelector('[name="description"]').value = obra.description || '';
      form.querySelector('[name="year"]').value = obra.year || '';
      form.querySelector('[name="status"]').value = obra.status || 'anterior';
      form.querySelector('[name="genre"]').value = obra.genre || '';
      form.querySelector('[name="youtubeId"]').value = obra.youtubeId || '';
      form.querySelector('[name="order"]').value = obra.order || '';
      form.querySelector('[name="originalPath"]').value = path;
      form.querySelector('[name="coverImage"]').value = obra.coverImage || '';

      // Reset and show existing images
      pendingCoverImage = null;
      pendingGalleryImages = [];
      existingGalleryImages = Array.isArray(obra.gallery) ? [...obra.gallery] : [];

      document.getElementById('coverImageFile').value = '';
      document.getElementById('galleryFiles').value = '';

      // Show cover preview
      if (obra.coverImage) {
        document.getElementById('coverImagePreview').innerHTML =
          `<img src="${obra.coverImage}" class="image-preview" onerror="this.style.display='none'">
           <p class="text-xs text-gray-500 mt-1">Imagen actual (selecciona otra para cambiar)</p>`;
      } else {
        document.getElementById('coverImagePreview').innerHTML = '';
      }

      // Show gallery preview
      const galleryPreview = document.getElementById('galleryPreview');
      galleryPreview.innerHTML = existingGalleryImages.map((img, idx) => `
        <div class="gallery-item" data-idx="${idx}" data-type="existing">
          <img src="${img}" class="image-preview" onerror="this.parentElement.style.display='none'">
          <button type="button" class="remove-btn" onclick="removeGalleryImage(${idx}, 'existing')">&times;</button>
        </div>
      `).join('');

      document.getElementById('modal').classList.remove('hidden');
      document.getElementById('modal').classList.add('flex');
      document.getElementById('form-obra').classList.remove('hidden');
      document.getElementById('form-representacion').classList.add('hidden');
      document.getElementById('modal-title').textContent = 'Editar Obra';
    }

    async function deleteRepresentacion(path, sha) {
      if (!confirm('¬øSeguro que quieres eliminar esta representaci√≥n?')) return;

      if (await deleteFile(path, sha)) {
        showToast('Eliminado correctamente');
        loadRepresentaciones();
      } else {
        alert('Error al eliminar');
      }
    }

    // Form submissions
    document.getElementById('form-representacion').addEventListener('submit', async (e) => {
      e.preventDefault();
      const form = e.target;
      const data = Object.fromEntries(new FormData(form));

      const obraOption = form.querySelector(`select[name="obraSlug"] option[value="${data.obraSlug}"]`);
      const obraTitle = obraOption ? obraOption.dataset.title : data.obraSlug;

      const content = `---
date: ${data.date}
time: "${data.time}"
venue: "${data.venue}"
city: "${data.city}"
province: "${data.province}"
obra: "${obraTitle}"
obraSlug: "${data.obraSlug}"${data.event ? `\nevent: "${data.event}"` : ''}${data.ticketUrl ? `\nticketUrl: "${data.ticketUrl}"` : ''}${data.price ? `\nprice: "${data.price}"` : ''}
---
`;

      const slug = data.city.toLowerCase().normalize('NFD').replace(/[\u0300-\u036f]/g, '').replace(/\s+/g, '-');
      const filename = `${data.date}-${slug}.md`;
      const path = data.originalPath || `src/content/representaciones/${filename}`;

      let sha = null;
      if (data.originalPath) {
        const existing = await getFile(data.originalPath);
        sha = existing?.sha;
      }

      if (await saveFile(path, content, sha)) {
        showToast('Guardado correctamente');
        closeModal();
        loadRepresentaciones();
      } else {
        alert('Error al guardar');
      }
    });

    document.getElementById('form-obra').addEventListener('submit', async (e) => {
      e.preventDefault();
      const form = e.target;
      const data = Object.fromEntries(new FormData(form));
      const submitBtn = document.getElementById('btn-submit-obra');
      const statusEl = document.getElementById('upload-status');

      submitBtn.disabled = true;
      submitBtn.textContent = 'Guardando...';
      statusEl.classList.remove('hidden');

      try {
        // Generate folder name from title
        const folderSlug = data.title.toLowerCase().normalize('NFD').replace(/[\u0300-\u036f]/g, '').replace(/\s+/g, '-');

        // Upload cover image if new one selected
        let coverImagePath = data.coverImage || '/images/placeholder.jpg';
        if (pendingCoverImage) {
          statusEl.textContent = 'Subiendo imagen de portada...';
          coverImagePath = await uploadImage(pendingCoverImage, `obras/${folderSlug}`);
        }

        // Upload new gallery images
        let galleryPaths = [...existingGalleryImages];
        if (pendingGalleryImages.length > 0) {
          statusEl.textContent = `Subiendo galer√≠a (0/${pendingGalleryImages.length})...`;
          for (let i = 0; i < pendingGalleryImages.length; i++) {
            statusEl.textContent = `Subiendo galer√≠a (${i + 1}/${pendingGalleryImages.length})...`;
            const path = await uploadImage(pendingGalleryImages[i], `galeria/${folderSlug}`);
            galleryPaths.push(path);
          }
        }

        statusEl.textContent = 'Guardando obra...';

        // Build gallery YAML
        let galleryYaml = '';
        if (galleryPaths.length > 0) {
          galleryYaml = '\ngallery:\n' + galleryPaths.map(p => `  - "${p}"`).join('\n');
        }

        const content = `---
title: "${data.title}"${data.author ? `\nauthor: "${data.author}"` : ''}
description: "${data.description}"${data.year ? `\nyear: ${data.year}` : ''}
status: "${data.status}"
coverImage: "${coverImagePath}"${galleryYaml}${data.genre ? `\ngenre: "${data.genre}"` : ''}${data.youtubeId ? `\nyoutubeId: "${data.youtubeId}"` : ''}${data.order ? `\norder: ${data.order}` : ''}
---

${data.title}
`;

        const slug = data.title.toLowerCase().normalize('NFD').replace(/[\u0300-\u036f]/g, '').replace(/\s+/g, '-');
        const filename = `${slug}.md`;
        const path = data.originalPath || `src/content/obras/${filename}`;

        let sha = null;
        if (data.originalPath) {
          const existing = await getFile(data.originalPath);
          sha = existing?.sha;
        }

        if (await saveFile(path, content, sha)) {
          showToast('Guardado correctamente');
          closeModal();
          loadObras();
        } else {
          alert('Error al guardar');
        }
      } catch (error) {
        alert('Error: ' + error.message);
      } finally {
        submitBtn.disabled = false;
        submitBtn.textContent = 'Guardar';
        statusEl.classList.add('hidden');
      }
    });

    // UI helpers
    function showTab(tab) {
      document.querySelectorAll('[id^="content-"]').forEach(el => el.classList.add('hidden'));
      document.querySelectorAll('[id^="tab-"]').forEach(el => {
        el.classList.remove('tab-active');
        el.classList.add('bg-gray-200');
      });
      document.getElementById(`content-${tab}`).classList.remove('hidden');
      document.getElementById(`tab-${tab}`).classList.add('tab-active');
      document.getElementById(`tab-${tab}`).classList.remove('bg-gray-200');
    }

    function showToast(msg) {
      const toast = document.getElementById('toast');
      toast.textContent = msg;
      toast.classList.remove('hidden');
      setTimeout(() => toast.classList.add('hidden'), 3000);
    }

    function formatDate(dateStr) {
      if (!dateStr) return '';
      const date = new Date(dateStr);
      return date.toLocaleDateString('es-ES', { day: 'numeric', month: 'short', year: 'numeric' });
    }

    // Init
    function init() {
      if (getToken()) {
        document.getElementById('login-section').classList.add('hidden');
        document.getElementById('admin-panel').classList.remove('hidden');
        loadObras();
        loadRepresentaciones();
      }
    }

    init();
  </script>
</body>
</html>
