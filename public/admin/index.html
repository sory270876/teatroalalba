<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Panel de Administraci√≥n - Teatro Al Alba</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    .tab-active { background-color: #7f1d1d; color: white; }
    .image-preview { max-width: 150px; max-height: 150px; object-fit: cover; border-radius: 8px; }
    .gallery-preview { display: flex; flex-wrap: wrap; gap: 8px; margin-top: 8px; }
    .gallery-item { position: relative; }
    .gallery-item .remove-btn { position: absolute; top: -8px; right: -8px; background: #dc2626; color: white; border-radius: 50%; width: 24px; height: 24px; font-size: 14px; cursor: pointer; }
    .certamen-item { border: 1px solid #e5e7eb; border-radius: 8px; padding: 16px; margin-bottom: 12px; }
    .premio-item { background: #f9fafb; padding: 8px; border-radius: 4px; margin-top: 8px; }
  </style>
</head>
<body class="bg-gray-100 min-h-screen">
  <!-- Login Section -->
  <div id="login-section" class="min-h-screen flex items-center justify-center">
    <div class="bg-white p-8 rounded-lg shadow-lg max-w-md w-full">
      <h1 class="text-2xl font-bold text-gray-800 mb-6 text-center">Panel de Administraci√≥n</h1>
      <p class="text-gray-600 mb-4 text-sm">
        Para usar el panel necesitas un token de GitHub.
        <a href="https://github.com/settings/tokens/new?description=Teatro%20Al%20Alba%20Admin&scopes=repo" target="_blank" class="text-red-700 underline">Crear token aqu√≠</a>
        (marca solo "repo" y genera).
      </p>
      <input type="password" id="token-input" placeholder="Pega tu token aqu√≠"
        class="w-full px-4 py-3 border rounded-lg mb-4 focus:outline-none focus:ring-2 focus:ring-red-600">
      <button onclick="saveToken()"
        class="w-full bg-red-800 text-white py-3 rounded-lg hover:bg-red-900 transition">
        Entrar
      </button>
      <p id="login-error" class="text-red-600 mt-2 text-sm hidden"></p>
    </div>
  </div>

  <!-- Admin Panel -->
  <div id="admin-panel" class="hidden">
    <!-- Header -->
    <header class="bg-red-900 text-white py-4 px-6 shadow-lg">
      <div class="max-w-6xl mx-auto flex justify-between items-center">
        <h1 class="text-xl font-bold">Teatro Al Alba - Admin</h1>
        <div class="flex gap-4 items-center">
          <a href="https://www.teatroalalba.es" target="_blank" class="text-sm hover:underline">Ver web</a>
          <button onclick="logout()" class="text-sm bg-red-800 px-3 py-1 rounded hover:bg-red-700">Salir</button>
        </div>
      </div>
    </header>

    <!-- Tabs -->
    <div class="max-w-6xl mx-auto mt-6 px-4">
      <div class="flex gap-2 mb-6 flex-wrap">
        <button onclick="showTab('representaciones')" id="tab-representaciones"
          class="px-6 py-2 rounded-lg font-medium tab-active transition">
          Representaciones
        </button>
        <button onclick="showTab('obras')" id="tab-obras"
          class="px-6 py-2 rounded-lg font-medium bg-gray-200 hover:bg-gray-300 transition">
          Obras
        </button>
        <button onclick="showTab('premios')" id="tab-premios"
          class="px-6 py-2 rounded-lg font-medium bg-gray-200 hover:bg-gray-300 transition">
          Premios
        </button>
      </div>

      <!-- Representaciones Tab -->
      <div id="content-representaciones" class="bg-white rounded-lg shadow-lg p-6">
        <div class="flex justify-between items-center mb-6">
          <h2 class="text-xl font-bold text-gray-800">Representaciones</h2>
          <button onclick="showForm('representacion')"
            class="bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700 transition">
            + Nueva Representaci√≥n
          </button>
        </div>
        <div id="representaciones-list" class="space-y-2">
          <p class="text-gray-500">Cargando...</p>
        </div>
      </div>

      <!-- Obras Tab -->
      <div id="content-obras" class="bg-white rounded-lg shadow-lg p-6 hidden">
        <div class="flex justify-between items-center mb-6">
          <h2 class="text-xl font-bold text-gray-800">Obras</h2>
          <button onclick="showForm('obra')"
            class="bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700 transition">
            + Nueva Obra
          </button>
        </div>
        <div id="obras-list" class="space-y-2">
          <p class="text-gray-500">Cargando...</p>
        </div>
      </div>

      <!-- Premios Tab -->
      <div id="content-premios" class="bg-white rounded-lg shadow-lg p-6 hidden">
        <div class="flex justify-between items-center mb-6">
          <h2 class="text-xl font-bold text-gray-800">Premios por Obra</h2>
          <button onclick="showForm('premio')"
            class="bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700 transition">
            + A√±adir Premios a Obra
          </button>
        </div>
        <div id="premios-list" class="space-y-2">
          <p class="text-gray-500">Cargando...</p>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal Form -->
  <div id="modal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
    <div class="bg-white rounded-lg shadow-xl max-w-2xl w-full mx-4 max-h-[90vh] overflow-y-auto">
      <div class="p-6">
        <div class="flex justify-between items-center mb-6">
          <h3 id="modal-title" class="text-xl font-bold text-gray-800">Nuevo</h3>
          <button onclick="closeModal()" class="text-gray-500 hover:text-gray-700 text-2xl">&times;</button>
        </div>

        <!-- Representacion Form -->
        <form id="form-representacion" class="space-y-4 hidden">
          <div class="grid grid-cols-2 gap-4">
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">Fecha *</label>
              <input type="date" name="date" required class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-red-600">
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">Hora *</label>
              <input type="time" name="time" required class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-red-600">
            </div>
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">Obra *</label>
            <select name="obraSlug" required class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-red-600">
              <option value="">Selecciona una obra...</option>
            </select>
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">Lugar/Teatro *</label>
            <input type="text" name="venue" required placeholder="Ej: Teatro Municipal"
              class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-red-600">
          </div>
          <div class="grid grid-cols-2 gap-4">
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">Ciudad *</label>
              <input type="text" name="city" required placeholder="Ej: Getafe"
                class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-red-600">
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">Provincia *</label>
              <input type="text" name="province" required placeholder="Ej: Madrid"
                class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-red-600">
            </div>
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">Evento/Festival (opcional)</label>
            <input type="text" name="event" placeholder="Ej: Festival de Teatro Amateur"
              class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-red-600">
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">URL de entradas (opcional)</label>
            <input type="url" name="ticketUrl" placeholder="https://..."
              class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-red-600">
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">Precio (opcional)</label>
            <input type="text" name="price" placeholder="Ej: 10‚Ç¨ / Gratuito"
              class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-red-600">
          </div>
          <input type="hidden" name="originalPath">
          <div class="flex gap-3 pt-4">
            <button type="submit" class="flex-1 bg-red-800 text-white py-3 rounded-lg hover:bg-red-900 transition">
              Guardar
            </button>
            <button type="button" onclick="closeModal()" class="flex-1 bg-gray-300 text-gray-700 py-3 rounded-lg hover:bg-gray-400 transition">
              Cancelar
            </button>
          </div>
        </form>

        <!-- Obra Form -->
        <form id="form-obra" class="space-y-4 hidden">
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">T√≠tulo *</label>
            <input type="text" name="title" required placeholder="Ej: 7 Stories"
              class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-red-600">
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">Autor</label>
            <input type="text" name="author" placeholder="Ej: Morris Panych"
              class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-red-600">
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">Descripci√≥n corta *</label>
            <textarea name="description" required rows="3" placeholder="Breve descripci√≥n de la obra..."
              class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-red-600"></textarea>
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">Contenido completo (sinopsis, info sobre la obra...)</label>
            <textarea name="body" rows="8" placeholder="Escribe aqu√≠ la informaci√≥n completa de la obra, sinopsis detallada, etc."
              class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-red-600"></textarea>
            <p class="text-xs text-gray-500 mt-1">Puedes usar formato: **negrita**, *cursiva*, &nbsp; para espacios</p>
          </div>
          <div class="grid grid-cols-2 gap-4">
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">A√±o</label>
              <input type="number" name="year" placeholder="2025"
                class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-red-600">
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">Estado *</label>
              <select name="status" required class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-red-600">
                <option value="cartelera">En cartelera</option>
                <option value="anterior">Obra anterior</option>
              </select>
            </div>
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">G√©nero</label>
            <input type="text" name="genre" placeholder="Ej: Comedia, Drama..."
              class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-red-600">
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">ID de YouTube (opcional)</label>
            <input type="text" name="youtubeId" placeholder="Ej: Mco1GdXSzFs"
              class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-red-600">
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">Orden (menor = primero)</label>
            <input type="number" name="order" placeholder="0"
              class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-red-600">
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">Imagen de portada *</label>
            <input type="file" id="coverImageFile" accept="image/*"
              class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-red-600">
            <div id="coverImagePreview" class="mt-2"></div>
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">Galer√≠a de im√°genes</label>
            <input type="file" id="galleryFiles" accept="image/*" multiple
              class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-red-600">
            <div id="galleryPreview" class="gallery-preview mt-2"></div>
          </div>
          <input type="hidden" name="originalPath">
          <input type="hidden" name="coverImage">
          <input type="hidden" name="gallery">
          <div class="flex gap-3 pt-4">
            <button type="submit" id="btn-submit-obra" class="flex-1 bg-red-800 text-white py-3 rounded-lg hover:bg-red-900 transition">
              Guardar
            </button>
            <button type="button" onclick="closeModal()" class="flex-1 bg-gray-300 text-gray-700 py-3 rounded-lg hover:bg-gray-400 transition">
              Cancelar
            </button>
          </div>
          <p id="upload-status" class="text-sm text-gray-500 text-center hidden">Subiendo im√°genes...</p>
        </form>

        <!-- Premio Form -->
        <form id="form-premio" class="space-y-4 hidden">
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">Obra *</label>
            <select name="obraSlug" required id="premio-obra-select" class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-red-600">
              <option value="">Selecciona una obra...</option>
            </select>
          </div>

          <div>
            <label class="block text-sm font-medium text-gray-700 mb-2">Cert√°menes y Premios</label>
            <div id="certamenes-container"></div>
            <button type="button" onclick="addCertamen()" class="mt-2 text-sm bg-blue-600 text-white px-3 py-1 rounded hover:bg-blue-700">
              + A√±adir Certamen
            </button>
          </div>

          <input type="hidden" name="originalPath">
          <input type="hidden" name="order">
          <div class="flex gap-3 pt-4">
            <button type="submit" class="flex-1 bg-red-800 text-white py-3 rounded-lg hover:bg-red-900 transition">
              Guardar
            </button>
            <button type="button" onclick="closeModal()" class="flex-1 bg-gray-300 text-gray-700 py-3 rounded-lg hover:bg-gray-400 transition">
              Cancelar
            </button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- Toast -->
  <div id="toast" class="fixed bottom-4 right-4 bg-green-600 text-white px-6 py-3 rounded-lg shadow-lg hidden">
    Guardado correctamente
  </div>

  <script>
    const REPO = 'sory270876/teatroalalba';
    const BRANCH = 'main';
    let obras = [];
    let premiosData = [];
    let pendingCoverImage = null;
    let pendingGalleryImages = [];
    let existingGalleryImages = [];
    let certamenCounter = 0;

    // Token management
    function getToken() {
      return localStorage.getItem('github_token');
    }

    function saveToken() {
      const token = document.getElementById('token-input').value.trim();
      if (!token) {
        showLoginError('Por favor, introduce el token');
        return;
      }
      fetch('https://api.github.com/user', {
        headers: { 'Authorization': `token ${token}` }
      })
      .then(r => {
        if (r.ok) {
          localStorage.setItem('github_token', token);
          init();
        } else {
          showLoginError('Token inv√°lido. Aseg√∫rate de copiar el token completo.');
        }
      })
      .catch(() => showLoginError('Error de conexi√≥n'));
    }

    function showLoginError(msg) {
      const el = document.getElementById('login-error');
      el.textContent = msg;
      el.classList.remove('hidden');
    }

    function logout() {
      localStorage.removeItem('github_token');
      location.reload();
    }

    // API calls
    async function githubAPI(endpoint, options = {}) {
      const token = getToken();
      const response = await fetch(`https://api.github.com/repos/${REPO}${endpoint}`, {
        ...options,
        headers: {
          'Authorization': `token ${token}`,
          'Accept': 'application/vnd.github.v3+json',
          ...options.headers
        }
      });
      return response;
    }

    async function getFiles(path) {
      const response = await githubAPI(`/contents/${path}?ref=${BRANCH}`);
      if (!response.ok) return [];
      return response.json();
    }

    async function getFile(path) {
      const response = await githubAPI(`/contents/${path}?ref=${BRANCH}`);
      if (!response.ok) return null;
      const data = await response.json();
      return {
        content: atob(data.content),
        sha: data.sha
      };
    }

    async function saveFile(path, content, sha = null) {
      const body = {
        message: `Update ${path} via admin panel`,
        content: btoa(unescape(encodeURIComponent(content))),
        branch: BRANCH
      };
      if (sha) body.sha = sha;

      const response = await githubAPI(`/contents/${path}`, {
        method: 'PUT',
        body: JSON.stringify(body)
      });
      return response.ok;
    }

    async function uploadImage(file, folder) {
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = async () => {
          const base64 = reader.result.split(',')[1];
          const filename = `${Date.now()}-${file.name.replace(/[^a-zA-Z0-9.-]/g, '_')}`;
          const path = `public/images/${folder}/${filename}`;

          const response = await githubAPI(`/contents/${path}`, {
            method: 'PUT',
            body: JSON.stringify({
              message: `Upload image ${filename}`,
              content: base64,
              branch: BRANCH
            })
          });

          if (response.ok) {
            resolve(`/images/${folder}/${filename}`);
          } else {
            reject(new Error('Error uploading image'));
          }
        };
        reader.onerror = reject;
        reader.readAsDataURL(file);
      });
    }

    async function deleteFile(path, sha) {
      const response = await githubAPI(`/contents/${path}`, {
        method: 'DELETE',
        body: JSON.stringify({
          message: `Delete ${path} via admin panel`,
          sha: sha,
          branch: BRANCH
        })
      });
      return response.ok;
    }

    // Parse YAML frontmatter (improved for nested structures)
    function parseFrontmatter(content) {
      const match = content.match(/^---\n([\s\S]*?)\n---/);
      if (!match) return {};

      try {
        const lines = match[1].split('\n');
        const result = {};
        let currentKey = null;
        let inCertamenes = false;
        let currentCertamen = null;
        let inPremios = false;

        for (let i = 0; i < lines.length; i++) {
          const line = lines[i];
          const indent = line.search(/\S/);

          if (indent === 0 && line.includes(':')) {
            // Match key: "value" or key: value patterns
            const keyMatch = line.match(/^([^:]+):\s*(.*)$/);
            if (keyMatch) {
              currentKey = keyMatch[1].trim();
              let value = keyMatch[2].trim();

              if (value === '') {
                if (currentKey === 'certamenes') {
                  result.certamenes = [];
                  inCertamenes = true;
                } else if (currentKey === 'gallery') {
                  result.gallery = [];
                }
              } else {
                // Handle quoted strings - extract content between quotes
                const quotedMatch = value.match(/^["'](.*)["']$/);
                if (quotedMatch) {
                  result[currentKey] = quotedMatch[1];
                } else {
                  result[currentKey] = value;
                }
                inCertamenes = false;
              }
            }
          } else if (line.trim().startsWith('- ') && !inCertamenes) {
            // Simple array item
            if (currentKey === 'gallery') {
              let val = line.trim().substring(2);
              const quotedMatch = val.match(/^["'](.*)["']$/);
              result.gallery.push(quotedMatch ? quotedMatch[1] : val);
            }
          } else if (inCertamenes && line.trim().startsWith('- nombre:')) {
            // New certamen
            let nombre = line.split('nombre:')[1].trim();
            const quotedMatch = nombre.match(/^["'](.*)["']$/);
            currentCertamen = { nombre: quotedMatch ? quotedMatch[1] : nombre, premios: [] };
            result.certamenes.push(currentCertamen);
            inPremios = false;
          } else if (inCertamenes && line.trim() === 'premios:') {
            inPremios = true;
          } else if (inCertamenes && inPremios && line.trim().startsWith('- tipo:')) {
            let tipo = line.split('tipo:')[1].trim();
            const quotedMatch = tipo.match(/^["'](.*)["']$/);
            const premio = { tipo: quotedMatch ? quotedMatch[1] : tipo };
            currentCertamen.premios.push(premio);
          } else if (inCertamenes && inPremios && line.trim().startsWith('categoria:')) {
            let cat = line.split('categoria:')[1].trim();
            const quotedMatch = cat.match(/^["'](.*)["']$/);
            currentCertamen.premios[currentCertamen.premios.length - 1].categoria = quotedMatch ? quotedMatch[1] : cat;
          } else if (inCertamenes && inPremios && line.trim().startsWith('persona:')) {
            let per = line.split('persona:')[1].trim();
            const quotedMatch = per.match(/^["'](.*)["']$/);
            currentCertamen.premios[currentCertamen.premios.length - 1].persona = quotedMatch ? quotedMatch[1] : per;
          }
        }

        return result;
      } catch (e) {
        console.error('Error parsing frontmatter:', e);
        return {};
      }
    }

    // Load data
    async function loadRepresentaciones() {
      const files = await getFiles('src/content/representaciones');
      const list = document.getElementById('representaciones-list');

      if (!files.length) {
        list.innerHTML = '<p class="text-gray-500">No hay representaciones</p>';
        return;
      }

      const items = [];
      for (const file of files) {
        if (!file.name.endsWith('.md')) continue;
        const data = await getFile(file.path);
        if (data) {
          const fm = parseFrontmatter(data.content);
          items.push({ ...fm, path: file.path, sha: data.sha });
        }
      }

      items.sort((a, b) => new Date(b.date) - new Date(a.date));

      list.innerHTML = items.map(item => `
        <div class="flex justify-between items-center p-4 bg-gray-50 rounded-lg hover:bg-gray-100">
          <div>
            <div class="font-medium text-gray-800">${item.obra || 'Sin obra'}</div>
            <div class="text-sm text-gray-600">${formatDate(item.date)} - ${item.time || ''} | ${item.venue || ''}, ${item.city || ''}</div>
          </div>
          <div class="flex gap-2">
            <button onclick="editRepresentacion('${item.path}')"
              class="text-blue-600 hover:text-blue-800 px-3 py-1 rounded border border-blue-600 hover:bg-blue-50">
              Editar
            </button>
            <button onclick="deleteRepresentacionItem('${item.path}', '${item.sha}')"
              class="text-red-600 hover:text-red-800 px-3 py-1 rounded border border-red-600 hover:bg-red-50">
              Eliminar
            </button>
          </div>
        </div>
      `).join('');
    }

    async function loadObras() {
      const files = await getFiles('src/content/obras');
      const list = document.getElementById('obras-list');
      obras = [];

      if (!files.length) {
        list.innerHTML = '<p class="text-gray-500">No hay obras</p>';
        return;
      }

      for (const file of files) {
        if (!file.name.endsWith('.md')) continue;
        const data = await getFile(file.path);
        if (data) {
          const fm = parseFrontmatter(data.content);
          const slug = file.name.replace('.md', '');
          obras.push({ ...fm, slug, path: file.path, sha: data.sha, rawContent: data.content });
        }
      }

      // Update selects
      const selectRep = document.querySelector('#form-representacion select[name="obraSlug"]');
      const selectPremio = document.getElementById('premio-obra-select');
      const options = '<option value="">Selecciona una obra...</option>' +
        obras.map(o => `<option value="${o.slug}" data-title="${o.title}" data-image="${o.coverImage || ''}">${o.title}</option>`).join('');
      selectRep.innerHTML = options;
      selectPremio.innerHTML = options;

      list.innerHTML = obras.map(item => `
        <div class="flex justify-between items-center p-4 bg-gray-50 rounded-lg hover:bg-gray-100">
          <div class="flex items-center gap-4">
            <img src="${item.coverImage || '/images/placeholder.jpg'}" class="w-16 h-16 object-cover rounded-lg" onerror="this.src='/images/placeholder.jpg'">
            <div>
              <div class="font-medium text-gray-800">${item.title || 'Sin t√≠tulo'}</div>
              <div class="text-sm text-gray-600">${item.status === 'cartelera' ? 'üé≠ En cartelera' : 'üìÅ Anterior'} | ${item.genre || ''}</div>
            </div>
          </div>
          <div class="flex gap-2">
            <button onclick="editObra('${item.path}')"
              class="text-blue-600 hover:text-blue-800 px-3 py-1 rounded border border-blue-600 hover:bg-blue-50">
              Editar
            </button>
            <button onclick="deleteObraItem('${item.path}', '${item.sha}')"
              class="text-red-600 hover:text-red-800 px-3 py-1 rounded border border-red-600 hover:bg-red-50">
              Eliminar
            </button>
          </div>
        </div>
      `).join('');
    }

    async function loadPremios() {
      const files = await getFiles('src/content/premios');
      const list = document.getElementById('premios-list');
      premiosData = [];

      if (!files.length) {
        list.innerHTML = '<p class="text-gray-500">No hay premios registrados</p>';
        return;
      }

      for (const file of files) {
        if (!file.name.endsWith('.md')) continue;
        const data = await getFile(file.path);
        if (data) {
          const fm = parseFrontmatter(data.content);
          premiosData.push({ ...fm, path: file.path, sha: data.sha });
        }
      }

      list.innerHTML = premiosData.map(item => {
        const totalPremios = (item.certamenes || []).reduce((acc, c) => acc + (c.premios || []).length, 0);
        return `
          <div class="flex justify-between items-center p-4 bg-gray-50 rounded-lg hover:bg-gray-100">
            <div class="flex items-center gap-4">
              <img src="${item.obraImage || '/images/placeholder.jpg'}" class="w-16 h-16 object-cover rounded-lg" onerror="this.src='/images/placeholder.jpg'">
              <div>
                <div class="font-medium text-gray-800">${item.obra || 'Sin obra'}</div>
                <div class="text-sm text-gray-600">üèÜ ${totalPremios} premios en ${(item.certamenes || []).length} cert√°menes</div>
              </div>
            </div>
            <div class="flex gap-2">
              <button onclick="editPremio('${item.path}')"
                class="text-blue-600 hover:text-blue-800 px-3 py-1 rounded border border-blue-600 hover:bg-blue-50">
                Editar
              </button>
              <button onclick="deletePremioItem('${item.path}', '${item.sha}')"
                class="text-red-600 hover:text-red-800 px-3 py-1 rounded border border-red-600 hover:bg-red-50">
                Eliminar
              </button>
            </div>
          </div>
        `;
      }).join('');
    }

    // Delete functions
    async function deleteRepresentacionItem(path, sha) {
      if (!confirm('¬øSeguro que quieres eliminar esta representaci√≥n?')) return;
      if (await deleteFile(path, sha)) {
        showToast('Eliminado correctamente');
        loadRepresentaciones();
      } else {
        alert('Error al eliminar');
      }
    }

    async function deleteObraItem(path, sha) {
      if (!confirm('¬øSeguro que quieres eliminar esta obra?')) return;
      if (await deleteFile(path, sha)) {
        showToast('Eliminado correctamente');
        loadObras();
      } else {
        alert('Error al eliminar');
      }
    }

    async function deletePremioItem(path, sha) {
      if (!confirm('¬øSeguro que quieres eliminar estos premios?')) return;
      if (await deleteFile(path, sha)) {
        showToast('Eliminado correctamente');
        loadPremios();
      } else {
        alert('Error al eliminar');
      }
    }

    // Image handling
    document.getElementById('coverImageFile').addEventListener('change', function(e) {
      const file = e.target.files[0];
      if (file) {
        pendingCoverImage = file;
        const reader = new FileReader();
        reader.onload = function(e) {
          document.getElementById('coverImagePreview').innerHTML =
            `<img src="${e.target.result}" class="image-preview">`;
        };
        reader.readAsDataURL(file);
      }
    });

    document.getElementById('galleryFiles').addEventListener('change', function(e) {
      const files = Array.from(e.target.files);
      files.forEach(file => {
        pendingGalleryImages.push(file);
        const reader = new FileReader();
        reader.onload = function(e) {
          const preview = document.getElementById('galleryPreview');
          const idx = pendingGalleryImages.length - 1 + existingGalleryImages.length;
          preview.innerHTML += `
            <div class="gallery-item" data-idx="${idx}" data-type="new">
              <img src="${e.target.result}" class="image-preview">
              <button type="button" class="remove-btn" onclick="removeGalleryImage(${idx}, 'new')">&times;</button>
            </div>
          `;
        };
        reader.readAsDataURL(file);
      });
    });

    function removeGalleryImage(idx, type) {
      if (type === 'new') {
        const adjustedIdx = idx - existingGalleryImages.length;
        pendingGalleryImages.splice(adjustedIdx, 1);
      } else {
        existingGalleryImages.splice(idx, 1);
      }
      document.querySelector(`.gallery-item[data-idx="${idx}"][data-type="${type}"]`)?.remove();
    }

    // Certamenes/Premios handling
    function addCertamen(certamen = null) {
      const container = document.getElementById('certamenes-container');
      const id = certamenCounter++;

      const div = document.createElement('div');
      div.className = 'certamen-item';
      div.id = `certamen-${id}`;
      div.innerHTML = `
        <div class="flex justify-between items-center mb-2">
          <input type="text" placeholder="Nombre del certamen" class="certamen-nombre flex-1 px-3 py-2 border rounded-lg" value="${certamen?.nombre || ''}">
          <button type="button" onclick="removeCertamen(${id})" class="ml-2 text-red-600 hover:text-red-800">‚úï</button>
        </div>
        <div class="premios-container" id="premios-${id}"></div>
        <button type="button" onclick="addPremio(${id})" class="mt-2 text-xs bg-gray-200 px-2 py-1 rounded hover:bg-gray-300">
          + A√±adir premio
        </button>
      `;
      container.appendChild(div);

      if (certamen?.premios) {
        certamen.premios.forEach(p => addPremio(id, p));
      }
    }

    function removeCertamen(id) {
      document.getElementById(`certamen-${id}`)?.remove();
    }

    function addPremio(certamenId, premio = null) {
      const container = document.getElementById(`premios-${certamenId}`);
      const div = document.createElement('div');
      div.className = 'premio-item flex gap-2 items-center';
      div.innerHTML = `
        <select class="premio-tipo px-2 py-1 border rounded text-sm">
          <option value="premio" ${premio?.tipo === 'premio' ? 'selected' : ''}>Premio</option>
          <option value="nominacion" ${premio?.tipo === 'nominacion' ? 'selected' : ''}>Nominaci√≥n</option>
          <option value="mencion" ${premio?.tipo === 'mencion' ? 'selected' : ''}>Menci√≥n</option>
        </select>
        <input type="text" placeholder="Categor√≠a" class="premio-categoria flex-1 px-2 py-1 border rounded text-sm" value="${premio?.categoria || ''}">
        <input type="text" placeholder="Persona (opc)" class="premio-persona px-2 py-1 border rounded text-sm w-32" value="${premio?.persona || ''}">
        <button type="button" onclick="this.parentElement.remove()" class="text-red-600 text-sm">‚úï</button>
      `;
      container.appendChild(div);
    }

    function getCertamenesData() {
      const certamenes = [];
      document.querySelectorAll('.certamen-item').forEach(certamenEl => {
        const nombre = certamenEl.querySelector('.certamen-nombre').value.trim();
        if (!nombre) return;

        const premios = [];
        certamenEl.querySelectorAll('.premio-item').forEach(premioEl => {
          const tipo = premioEl.querySelector('.premio-tipo').value;
          const categoria = premioEl.querySelector('.premio-categoria').value.trim();
          const persona = premioEl.querySelector('.premio-persona').value.trim();
          if (categoria) {
            premios.push({ tipo, categoria, persona: persona || null });
          }
        });

        if (premios.length > 0) {
          certamenes.push({ nombre, premios });
        }
      });
      return certamenes;
    }

    // Forms
    function showForm(type) {
      document.getElementById('modal').classList.remove('hidden');
      document.getElementById('modal').classList.add('flex');
      document.getElementById('form-representacion').classList.add('hidden');
      document.getElementById('form-obra').classList.add('hidden');
      document.getElementById('form-premio').classList.add('hidden');
      document.getElementById(`form-${type}`).classList.remove('hidden');
      document.getElementById(`form-${type}`).reset();

      const originalPathInput = document.querySelector(`#form-${type} input[name="originalPath"]`);
      if (originalPathInput) originalPathInput.value = '';

      if (type === 'representacion') {
        document.getElementById('modal-title').textContent = 'Nueva Representaci√≥n';
      } else if (type === 'obra') {
        document.getElementById('modal-title').textContent = 'Nueva Obra';
        pendingCoverImage = null;
        pendingGalleryImages = [];
        existingGalleryImages = [];
        document.getElementById('coverImagePreview').innerHTML = '';
        document.getElementById('galleryPreview').innerHTML = '';
        document.getElementById('coverImageFile').value = '';
        document.getElementById('galleryFiles').value = '';
      } else if (type === 'premio') {
        document.getElementById('modal-title').textContent = 'A√±adir Premios a Obra';
        document.getElementById('certamenes-container').innerHTML = '';
        certamenCounter = 0;
        addCertamen();
      }
    }

    function closeModal() {
      document.getElementById('modal').classList.add('hidden');
      document.getElementById('modal').classList.remove('flex');
      pendingCoverImage = null;
      pendingGalleryImages = [];
      existingGalleryImages = [];
    }

    async function editRepresentacion(path) {
      const data = await getFile(path);
      if (!data) return;

      const fm = parseFrontmatter(data.content);
      const form = document.getElementById('form-representacion');

      form.querySelector('[name="date"]').value = fm.date || '';
      form.querySelector('[name="time"]').value = fm.time || '';
      form.querySelector('[name="venue"]').value = fm.venue || '';
      form.querySelector('[name="city"]').value = fm.city || '';
      form.querySelector('[name="province"]').value = fm.province || '';
      form.querySelector('[name="obraSlug"]').value = fm.obraSlug || '';
      form.querySelector('[name="event"]').value = fm.event || '';
      form.querySelector('[name="ticketUrl"]').value = fm.ticketUrl || '';
      form.querySelector('[name="price"]').value = fm.price || '';
      form.querySelector('[name="originalPath"]').value = path;

      document.getElementById('modal').classList.remove('hidden');
      document.getElementById('modal').classList.add('flex');
      document.getElementById('form-representacion').classList.remove('hidden');
      document.getElementById('form-obra').classList.add('hidden');
      document.getElementById('form-premio').classList.add('hidden');
      document.getElementById('modal-title').textContent = 'Editar Representaci√≥n';
    }

    async function editObra(path) {
      const obra = obras.find(o => o.path === path);
      if (!obra) return;

      const form = document.getElementById('form-obra');

      // Extract body content (after frontmatter)
      let bodyContent = '';
      if (obra.rawContent) {
        const bodyMatch = obra.rawContent.match(/^---[\s\S]*?---\n+([\s\S]*)$/);
        if (bodyMatch) {
          bodyContent = bodyMatch[1].trim();
        }
      }

      form.querySelector('[name="title"]').value = obra.title || '';
      form.querySelector('[name="author"]').value = obra.author || '';
      form.querySelector('[name="description"]').value = obra.description || '';
      form.querySelector('[name="body"]').value = bodyContent;
      form.querySelector('[name="year"]').value = obra.year || '';
      form.querySelector('[name="status"]').value = obra.status || 'anterior';
      form.querySelector('[name="genre"]').value = obra.genre || '';
      form.querySelector('[name="youtubeId"]').value = obra.youtubeId || '';
      form.querySelector('[name="order"]').value = obra.order || '';
      form.querySelector('[name="originalPath"]').value = path;
      form.querySelector('[name="coverImage"]').value = obra.coverImage || '';

      pendingCoverImage = null;
      pendingGalleryImages = [];
      existingGalleryImages = Array.isArray(obra.gallery) ? [...obra.gallery] : [];

      document.getElementById('coverImageFile').value = '';
      document.getElementById('galleryFiles').value = '';

      if (obra.coverImage) {
        document.getElementById('coverImagePreview').innerHTML =
          `<img src="${obra.coverImage}" class="image-preview" onerror="this.style.display='none'">
           <p class="text-xs text-gray-500 mt-1">Imagen actual</p>`;
      } else {
        document.getElementById('coverImagePreview').innerHTML = '';
      }

      const galleryPreview = document.getElementById('galleryPreview');
      galleryPreview.innerHTML = existingGalleryImages.map((img, idx) => `
        <div class="gallery-item" data-idx="${idx}" data-type="existing">
          <img src="${img}" class="image-preview" onerror="this.parentElement.style.display='none'">
          <button type="button" class="remove-btn" onclick="removeGalleryImage(${idx}, 'existing')">&times;</button>
        </div>
      `).join('');

      document.getElementById('modal').classList.remove('hidden');
      document.getElementById('modal').classList.add('flex');
      document.getElementById('form-obra').classList.remove('hidden');
      document.getElementById('form-representacion').classList.add('hidden');
      document.getElementById('form-premio').classList.add('hidden');
      document.getElementById('modal-title').textContent = 'Editar Obra';
    }

    async function editPremio(path) {
      const premio = premiosData.find(p => p.path === path);
      if (!premio) return;

      const form = document.getElementById('form-premio');
      form.querySelector('[name="obraSlug"]').value = premio.obraSlug || '';
      form.querySelector('[name="originalPath"]').value = path;
      form.querySelector('[name="order"]').value = premio.order || '';

      document.getElementById('certamenes-container').innerHTML = '';
      certamenCounter = 0;

      if (premio.certamenes && premio.certamenes.length > 0) {
        premio.certamenes.forEach(c => addCertamen(c));
      } else {
        addCertamen();
      }

      document.getElementById('modal').classList.remove('hidden');
      document.getElementById('modal').classList.add('flex');
      document.getElementById('form-premio').classList.remove('hidden');
      document.getElementById('form-representacion').classList.add('hidden');
      document.getElementById('form-obra').classList.add('hidden');
      document.getElementById('modal-title').textContent = 'Editar Premios';
    }

    // Form submissions
    document.getElementById('form-representacion').addEventListener('submit', async (e) => {
      e.preventDefault();
      const form = e.target;
      const data = Object.fromEntries(new FormData(form));

      const obraOption = form.querySelector(`select[name="obraSlug"] option[value="${data.obraSlug}"]`);
      const obraTitle = obraOption ? obraOption.dataset.title : data.obraSlug;

      const content = `---
date: ${data.date}
time: "${data.time}"
venue: "${data.venue}"
city: "${data.city}"
province: "${data.province}"
obra: "${obraTitle}"
obraSlug: "${data.obraSlug}"${data.event ? `\nevent: "${data.event}"` : ''}${data.ticketUrl ? `\nticketUrl: "${data.ticketUrl}"` : ''}${data.price ? `\nprice: "${data.price}"` : ''}
---
`;

      const slug = data.city.toLowerCase().normalize('NFD').replace(/[\u0300-\u036f]/g, '').replace(/\s+/g, '-');
      const filename = `${data.date}-${slug}.md`;
      const path = data.originalPath || `src/content/representaciones/${filename}`;

      let sha = null;
      if (data.originalPath) {
        const existing = await getFile(data.originalPath);
        sha = existing?.sha;
      }

      if (await saveFile(path, content, sha)) {
        showToast('Guardado correctamente');
        closeModal();
        loadRepresentaciones();
      } else {
        alert('Error al guardar');
      }
    });

    document.getElementById('form-obra').addEventListener('submit', async (e) => {
      e.preventDefault();
      const form = e.target;
      const data = Object.fromEntries(new FormData(form));
      const submitBtn = document.getElementById('btn-submit-obra');
      const statusEl = document.getElementById('upload-status');

      submitBtn.disabled = true;
      submitBtn.textContent = 'Guardando...';
      statusEl.classList.remove('hidden');

      try {
        const folderSlug = data.title.toLowerCase().normalize('NFD').replace(/[\u0300-\u036f]/g, '').replace(/\s+/g, '-');

        let coverImagePath = data.coverImage || '/images/placeholder.jpg';
        if (pendingCoverImage) {
          statusEl.textContent = 'Subiendo imagen de portada...';
          coverImagePath = await uploadImage(pendingCoverImage, `obras/${folderSlug}`);
        }

        let galleryPaths = [...existingGalleryImages];
        if (pendingGalleryImages.length > 0) {
          for (let i = 0; i < pendingGalleryImages.length; i++) {
            statusEl.textContent = `Subiendo galer√≠a (${i + 1}/${pendingGalleryImages.length})...`;
            const path = await uploadImage(pendingGalleryImages[i], `galeria/${folderSlug}`);
            galleryPaths.push(path);
          }
        }

        statusEl.textContent = 'Guardando obra...';

        let galleryYaml = '';
        if (galleryPaths.length > 0) {
          galleryYaml = '\ngallery:\n' + galleryPaths.map(p => `  - "${p}"`).join('\n');
        }

        const bodyContent = data.body ? data.body.trim() : data.title;

        const content = `---
title: "${data.title}"${data.author ? `\nauthor: "${data.author}"` : ''}
description: "${data.description}"${data.year ? `\nyear: ${data.year}` : ''}
status: "${data.status}"
coverImage: "${coverImagePath}"${galleryYaml}${data.genre ? `\ngenre: "${data.genre}"` : ''}${data.youtubeId ? `\nyoutubeId: "${data.youtubeId}"` : ''}${data.order ? `\norder: ${data.order}` : ''}
---

${bodyContent}
`;

        const slug = data.title.toLowerCase().normalize('NFD').replace(/[\u0300-\u036f]/g, '').replace(/\s+/g, '-');
        const filename = `${slug}.md`;
        const path = data.originalPath || `src/content/obras/${filename}`;

        let sha = null;
        if (data.originalPath) {
          const existing = await getFile(data.originalPath);
          sha = existing?.sha;
        }

        if (await saveFile(path, content, sha)) {
          showToast('Guardado correctamente');
          closeModal();
          loadObras();
        } else {
          alert('Error al guardar');
        }
      } catch (error) {
        alert('Error: ' + error.message);
      } finally {
        submitBtn.disabled = false;
        submitBtn.textContent = 'Guardar';
        statusEl.classList.add('hidden');
      }
    });

    document.getElementById('form-premio').addEventListener('submit', async (e) => {
      e.preventDefault();
      const form = e.target;
      const data = Object.fromEntries(new FormData(form));

      const obraOption = form.querySelector(`select[name="obraSlug"] option[value="${data.obraSlug}"]`);
      const obraTitle = obraOption ? obraOption.dataset.title : data.obraSlug;
      const obraImage = obraOption ? obraOption.dataset.image : '';

      const certamenes = getCertamenesData();

      if (certamenes.length === 0) {
        alert('A√±ade al menos un certamen con premios');
        return;
      }

      // Build YAML for certamenes
      let certamenesYaml = 'certamenes:\n';
      certamenes.forEach(c => {
        certamenesYaml += `  - nombre: "${c.nombre}"\n`;
        certamenesYaml += `    premios:\n`;
        c.premios.forEach(p => {
          certamenesYaml += `      - tipo: "${p.tipo}"\n`;
          certamenesYaml += `        categoria: "${p.categoria}"\n`;
          if (p.persona) {
            certamenesYaml += `        persona: "${p.persona}"\n`;
          }
        });
      });

      const content = `---
obra: "${obraTitle}"
obraSlug: "${data.obraSlug}"
obraImage: "${obraImage}"${data.order ? `\norder: ${data.order}` : ''}
${certamenesYaml}---
`;

      const slug = data.obraSlug;
      const filename = `${slug}.md`;
      const path = data.originalPath || `src/content/premios/${filename}`;

      let sha = null;
      if (data.originalPath) {
        const existing = await getFile(data.originalPath);
        sha = existing?.sha;
      }

      if (await saveFile(path, content, sha)) {
        showToast('Guardado correctamente');
        closeModal();
        loadPremios();
      } else {
        alert('Error al guardar');
      }
    });

    // UI helpers
    function showTab(tab) {
      document.querySelectorAll('[id^="content-"]').forEach(el => el.classList.add('hidden'));
      document.querySelectorAll('[id^="tab-"]').forEach(el => {
        el.classList.remove('tab-active');
        el.classList.add('bg-gray-200');
      });
      document.getElementById(`content-${tab}`).classList.remove('hidden');
      document.getElementById(`tab-${tab}`).classList.add('tab-active');
      document.getElementById(`tab-${tab}`).classList.remove('bg-gray-200');
    }

    function showToast(msg) {
      const toast = document.getElementById('toast');
      toast.textContent = msg;
      toast.classList.remove('hidden');
      setTimeout(() => toast.classList.add('hidden'), 3000);
    }

    function formatDate(dateStr) {
      if (!dateStr) return '';
      const date = new Date(dateStr);
      return date.toLocaleDateString('es-ES', { day: 'numeric', month: 'short', year: 'numeric' });
    }

    // Init
    function init() {
      if (getToken()) {
        document.getElementById('login-section').classList.add('hidden');
        document.getElementById('admin-panel').classList.remove('hidden');
        loadObras();
        loadRepresentaciones();
        loadPremios();
      }
    }

    init();
  </script>
</body>
</html>
